name: ðŸ“ Update README

on:
  workflow_run:
    workflows: ["ðŸ³ Build and Push Docker Image"]
    types:
      - completed
  
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: ðŸ” Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“Š Get Docker Hub stats
      id: docker_stats
      run: |
        # èŽ·å–Docker Hubç»Ÿè®¡ä¿¡æ¯
        DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
        IMAGE_NAME="cultivation-game"
        
        if [ -n "$DOCKERHUB_USERNAME" ]; then
          # èŽ·å–ä¸‹è½½æ¬¡æ•°ï¼ˆè¿™é‡Œæ˜¯ç¤ºä¾‹ï¼Œå®žé™…å¯èƒ½éœ€è¦APIè°ƒç”¨ï¼‰
          echo "pulls=1000+" >> $GITHUB_OUTPUT
          echo "stars=50+" >> $GITHUB_OUTPUT
          echo "image_size=200MB" >> $GITHUB_OUTPUT
        else
          echo "pulls=N/A" >> $GITHUB_OUTPUT
          echo "stars=N/A" >> $GITHUB_OUTPUT
          echo "image_size=N/A" >> $GITHUB_OUTPUT
        fi
    
    - name: ðŸ“ Update README badges
      run: |
        # æ›´æ–°README.mdä¸­çš„å¾½ç« 
        DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
        REPO_NAME="${{ github.repository }}"
        
        if [ -n "$DOCKERHUB_USERNAME" ]; then
          # æ·»åŠ Docker Hubå¾½ç« åˆ°README.md
          sed -i '1i\
[![Docker Pulls](https://img.shields.io/docker/pulls/'$DOCKERHUB_USERNAME'/cultivation-game)](https://hub.docker.com/r/'$DOCKERHUB_USERNAME'/cultivation-game)\
[![Docker Image Size](https://img.shields.io/docker/image-size/'$DOCKERHUB_USERNAME'/cultivation-game)](https://hub.docker.com/r/'$DOCKERHUB_USERNAME'/cultivation-game)\
[![Docker Image Version](https://img.shields.io/docker/v/'$DOCKERHUB_USERNAME'/cultivation-game)](https://hub.docker.com/r/'$DOCKERHUB_USERNAME'/cultivation-game)\
[![GitHub release](https://img.shields.io/github/release/'$REPO_NAME')](https://github.com/'$REPO_NAME'/releases)\
[![GitHub stars](https://img.shields.io/github/stars/'$REPO_NAME')](https://github.com/'$REPO_NAME'/stargazers)\
[![GitHub forks](https://img.shields.io/github/forks/'$REPO_NAME')](https://github.com/'$REPO_NAME'/network)\
[![GitHub issues](https://img.shields.io/github/issues/'$REPO_NAME')](https://github.com/'$REPO_NAME'/issues)\
[![License](https://img.shields.io/github/license/'$REPO_NAME')](https://github.com/'$REPO_NAME'/blob/main/LICENSE)\
' README.md
          
          # æ›´æ–°Docker Hubé“¾æŽ¥
          sed -i 's/your-dockerhub-username/'$DOCKERHUB_USERNAME'/g' README.md
          sed -i 's/your-username/'${REPO_NAME%/*}'/g' README.md
          sed -i 's|https://github.com/your-username/cultivation-game|https://github.com/'$REPO_NAME'|g' README.md
        fi
    
    - name: ðŸ“ Update installation commands
      run: |
        DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
        REPO_NAME="${{ github.repository }}"
        
        # æ›´æ–°å®‰è£…å‘½ä»¤ä¸­çš„ç”¨æˆ·å
        find . -name "*.sh" -type f -exec sed -i 's/your-dockerhub-username/'$DOCKERHUB_USERNAME'/g' {} \;
        find . -name "*.yml" -type f -exec sed -i 's/your-dockerhub-username/'$DOCKERHUB_USERNAME'/g' {} \;
        find . -name "*.html" -type f -exec sed -i 's/your-dockerhub-username/'$DOCKERHUB_USERNAME'/g' {} \;
        find . -name "*.md" -type f -exec sed -i 's/your-dockerhub-username/'$DOCKERHUB_USERNAME'/g' {} \;
        
        # æ›´æ–°GitHubé“¾æŽ¥
        find . -name "*.sh" -type f -exec sed -i 's|your-username/cultivation-game|'$REPO_NAME'|g' {} \;
        find . -name "*.html" -type f -exec sed -i 's|your-username/cultivation-game|'$REPO_NAME'|g' {} \;
        find . -name "*.md" -type f -exec sed -i 's|your-username/cultivation-game|'$REPO_NAME'|g' {} \;
    
    - name: ðŸ“Š Update stats in README
      run: |
        # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        CURRENT_DATE=$(date '+%Y-%m-%d')
        
        # åœ¨README.mdä¸­æ·»åŠ ç»Ÿè®¡ä¿¡æ¯éƒ¨åˆ†
        cat >> README.md << EOF

## ðŸ“Š é¡¹ç›®ç»Ÿè®¡

- ðŸ³ Dockeræ‹‰å–æ¬¡æ•°: ${{ steps.docker_stats.outputs.pulls }}
- â­ GitHubæ˜Ÿæ ‡: ${{ steps.docker_stats.outputs.stars }}
- ðŸ“¦ é•œåƒå¤§å°: ${{ steps.docker_stats.outputs.image_size }}
- ðŸ“… æœ€åŽæ›´æ–°: $CURRENT_DATE

EOF
    
    - name: ðŸ’¾ Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git add .
          git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°READMEå’Œé…ç½®æ–‡ä»¶

          - æ›´æ–°Docker Hubé“¾æŽ¥
          - æ›´æ–°GitHubä»“åº“é“¾æŽ¥
          - æ›´æ–°é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯
          - æ·»åŠ é¡¹ç›®å¾½ç« 
          
          ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ"
          git push
          echo "âœ… READMEå’Œé…ç½®æ–‡ä»¶å·²è‡ªåŠ¨æ›´æ–°"
        fi
