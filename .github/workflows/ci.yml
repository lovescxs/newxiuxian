name: ğŸ” CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    
    steps:
    - name: ğŸ” Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json
    
    - name: ğŸ“‹ Validate composer.json (if exists)
      run: |
        if [ -f "composer.json" ]; then
          composer validate --strict
        else
          echo "No composer.json found, skipping validation"
        fi
    
    - name: ğŸ” PHP Syntax Check
      run: |
        find . -name "*.php" -exec php -l {} \; | grep -v "No syntax errors"
        if [ $? -eq 0 ]; then
          echo "âŒ PHPè¯­æ³•é”™è¯¯"
          exit 1
        else
          echo "âœ… PHPè¯­æ³•æ£€æŸ¥é€šè¿‡"
        fi
    
    - name: ğŸ” JavaScript Syntax Check
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ğŸ“ Check JavaScript
      run: |
        # æ£€æŸ¥JavaScriptè¯­æ³•
        if command -v node &> /dev/null; then
          find . -name "*.js" -exec node -c {} \;
          echo "âœ… JavaScriptè¯­æ³•æ£€æŸ¥é€šè¿‡"
        fi
    
    - name: ğŸ” HTML Validation
      run: |
        # ç®€å•çš„HTMLæ£€æŸ¥
        find . -name "*.html" -exec echo "æ£€æŸ¥ {}" \;
        echo "âœ… HTMLæ–‡ä»¶æ£€æŸ¥å®Œæˆ"
    
    - name: ğŸ“Š File Structure Check
      run: |
        echo "ğŸ“ æ£€æŸ¥é¡¹ç›®ç»“æ„..."
        
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶
        required_files=("index.html" "game.js" "style.css" "Dockerfile" "docker-compose.yml")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
        # æ£€æŸ¥APIç›®å½•
        if [ -d "api" ]; then
          echo "âœ… apiç›®å½•å­˜åœ¨"
          api_files=("config.php" "index.php" "auth.php" "game.php")
          for file in "${api_files[@]}"; do
            if [ -f "api/$file" ]; then
              echo "âœ… api/$file å­˜åœ¨"
            else
              echo "âŒ api/$file ç¼ºå¤±"
              exit 1
            fi
          done
        else
          echo "âŒ apiç›®å½•ç¼ºå¤±"
          exit 1
        fi

  docker-test:
    runs-on: ubuntu-latest
    name: ğŸ³ Dockeræ„å»ºæµ‹è¯•
    needs: code-quality
    
    steps:
    - name: ğŸ” Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”¨ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: cultivation-game:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: ğŸ§ª Test Docker image
      run: |
        echo "ğŸ§ª æµ‹è¯•Dockeré•œåƒ..."
        
        # å¯åŠ¨æµ‹è¯•å®¹å™¨
        docker run -d --name test-cultivation \
          -p 8080:80 \
          cultivation-game:test
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        sleep 15
        
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if docker ps | grep test-cultivation; then
          echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ"
        else
          echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
          docker logs test-cultivation
          exit 1
        fi
        
        # æµ‹è¯•HTTPå“åº”
        for i in {1..5}; do
          if curl -f http://localhost:8080; then
            echo "âœ… HTTPæœåŠ¡æ­£å¸¸"
            break
          else
            echo "â³ ç­‰å¾…HTTPæœåŠ¡å¯åŠ¨... ($i/5)"
            sleep 5
          fi
          
          if [ $i -eq 5 ]; then
            echo "âŒ HTTPæœåŠ¡å¼‚å¸¸"
            docker logs test-cultivation
            exit 1
          fi
        done
        
        # æµ‹è¯•APIç«¯ç‚¹
        if curl -f http://localhost:8080/api/test; then
          echo "âœ… APIæœåŠ¡æ­£å¸¸"
        else
          echo "âš ï¸  APIæœåŠ¡å¯èƒ½éœ€è¦æ•°æ®åº“è¿æ¥"
        fi
        
        # æ¸…ç†
        docker stop test-cultivation
        docker rm test-cultivation
        
        echo "âœ… Dockeré•œåƒæµ‹è¯•é€šè¿‡"

  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ å®‰å…¨æ‰«æ
    needs: docker-test
    
    steps:
    - name: ğŸ” Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ”’ Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: ğŸ“¤ Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: ğŸ” Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  performance-test:
    runs-on: ubuntu-latest
    name: âš¡ æ€§èƒ½æµ‹è¯•
    needs: docker-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ” Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ³ Build and run
      run: |
        docker build -t cultivation-game:perf .
        docker run -d --name perf-test -p 8080:80 cultivation-game:perf
        sleep 15
    
    - name: âš¡ Performance test with Apache Bench
      run: |
        # å®‰è£…Apache Bench
        sudo apt-get update
        sudo apt-get install -y apache2-utils
        
        # æ€§èƒ½æµ‹è¯•
        echo "ğŸš€ å¼€å§‹æ€§èƒ½æµ‹è¯•..."
        ab -n 100 -c 10 http://localhost:8080/ > perf-results.txt
        
        # æ˜¾ç¤ºç»“æœ
        cat perf-results.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„è¯·æ±‚
        failed_requests=$(grep "Failed requests:" perf-results.txt | awk '{print $3}')
        if [ "$failed_requests" -gt 0 ]; then
          echo "âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥: $failed_requests ä¸ªè¯·æ±‚å¤±è´¥"
          exit 1
        else
          echo "âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡"
        fi
    
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        docker stop perf-test || true
        docker rm perf-test || true
