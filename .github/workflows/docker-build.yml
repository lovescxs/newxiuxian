name: ğŸ³ Build and Push Docker Image

on:
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  
  # åˆ›å»ºæ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: false
        default: 'latest'

env:
  REGISTRY: docker.io
  IMAGE_NAME: cultivation-game

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”‘ Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: ğŸ“‹ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
        tags: |
          # è®¾ç½®latestæ ‡ç­¾ç”¨äºmainåˆ†æ”¯
          type=ref,event=branch
          type=ref,event=pr
          # ä»gitæ ‡ç­¾æå–ç‰ˆæœ¬å·
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          # ä¸ºmainåˆ†æ”¯è®¾ç½®latestæ ‡ç­¾
          type=raw,value=latest,enable={{is_default_branch}}
          # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
          type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event_name == 'workflow_dispatch' }}
    
    - name: ğŸ”¨ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: ğŸ§ª Test Docker image
      run: |
        echo "ğŸ§ª æµ‹è¯•Dockeré•œåƒ..."
        
        # å¯åŠ¨æµ‹è¯•å®¹å™¨
        docker run -d --name test-cultivation \
          -p 8080:80 \
          -e DB_HOST=localhost \
          -e DB_NAME=test_db \
          -e DB_USER=test_user \
          -e DB_PASS=test_pass \
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        sleep 10
        
        # æµ‹è¯•HTTPå“åº”
        if curl -f http://localhost:8080; then
          echo "âœ… HTTPæœåŠ¡æ­£å¸¸"
        else
          echo "âŒ HTTPæœåŠ¡å¼‚å¸¸"
          docker logs test-cultivation
          exit 1
        fi
        
        # æ¸…ç†æµ‹è¯•å®¹å™¨
        docker stop test-cultivation
        docker rm test-cultivation
        
        echo "âœ… é•œåƒæµ‹è¯•é€šè¿‡"
    
    - name: ğŸ“Š Image scan
      uses: anchore/scan-action@v3
      id: scan
      with:
        image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        fail-build: false
        severity-cutoff: high
    
    - name: ğŸ“‹ Upload scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: ${{ steps.scan.outputs.sarif }}
    
    - name: ğŸ‰ Success notification
      if: success()
      run: |
        echo "ğŸ‰ Dockeré•œåƒæ„å»ºå’Œæ¨é€æˆåŠŸï¼"
        echo ""
        echo "ğŸ“¦ é•œåƒä¿¡æ¯:"
        echo "   ä»“åº“: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
        echo "   æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
        echo ""
        echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
        echo "   docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
        echo "   docker run -d -p 8080:80 ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
